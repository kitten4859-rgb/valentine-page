<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Valentineâ€™s Chocolates â€” Open & Taste</title>
  <meta name="description" content="ì´ˆì½œë¦¿ì„ í•˜ë‚˜ì”© ì—´ì–´ í¸ì§€ë¥¼ í™•ì¸í•˜ê³ , ì‹œì‹í‰ì„ ì €ì¥í•˜ëŠ” ë°œë Œíƒ€ì¸ë°ì´ í˜ì´ì§€" />
  <style>
    :root{
      --ink:#2a1b1f;
      --cream:#fff7f2;
      --rose:#d64a6a;
      --rose2:#ffb8c8;
      --velvet1:#3b0b1f;
      --velvet2:#14040a;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --softShadow: 0 10px 30px rgba(0,0,0,.22);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Apple SD Gothic Neo",
                   "Noto Sans KR", Segoe UI, Roboto, Helvetica, Arial;
      overflow-x:hidden;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(140deg, var(--velvet1), var(--velvet2));
    }

    /* ë°°ê²½: ë²¨ë²³ ì²œ ì´ë¯¸ì§€ + ì˜¤ë²„ë ˆì´ */
    .bg{
      position:fixed; inset:0;
      pointer-events:none;
      background-image:
        radial-gradient(1200px 800px at 30% 20%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 700px at 75% 55%, rgba(255,255,255,.08), transparent 55%),
        url("assets/bg.jpg");
      background-size: cover;
      background-position: center;
      filter: saturate(1.05) contrast(1.05) brightness(.92);
      opacity:.55;
      mix-blend-mode: overlay;
    }
    .grain{
      position:fixed; inset:-20%;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.20'/%3E%3C/svg%3E");
      transform: rotate(8deg);
      opacity:.18;
      mix-blend-mode: soft-light;
    }

    .wrap{
      position:relative;
      min-height:100%;
      display:flex;
      flex-direction:column;
      gap:18px;
      padding: 28px 18px 110px;
      max-width: 1100px;
      margin: 0 auto;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      padding: 10px 6px 0;
    }
    .title{display:flex; flex-direction:column; gap:6px;}
    h1{
      margin:0;
      font-size: clamp(22px, 2.6vw, 36px);
      letter-spacing: -.02em;
      color: rgba(255,255,255,.92);
      text-shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    .sub{
      margin:0;
      color: rgba(255,255,255,.78);
      font-size: 14px;
      line-height: 1.4;
    }

    .progress{
      display:flex;
      align-items:center;
      gap:10px;
      color: rgba(255,255,255,.8);
      font-size: 13px;
      user-select:none;
      white-space:nowrap;
    }
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }

    /* ì´ˆì½œë¦¿ ë°•ìŠ¤ ë¬´ëŒ€ */
    .boxStage{
      position:relative;
      border-radius: calc(var(--radius) + 10px);
      overflow:hidden;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.18);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20)),
        url("assets/box.jpg");
      background-size: cover;
      background-position: center;
      min-height: 520px;
    }
    .boxOverlay{
      position:absolute; inset:0;
      background:
        radial-gradient(800px 520px at 30% 20%, rgba(255,255,255,.18), transparent 60%),
        radial-gradient(700px 520px at 80% 60%, rgba(255,255,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.20), rgba(0,0,0,.45));
      pointer-events:none;
    }

    .grid{
      position:relative;
      padding: 26px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 16px;
    }
    @media (max-width: 820px){
      .grid{grid-template-columns: repeat(3, 1fr)}
      .boxStage{min-height: 640px}
    }
    @media (max-width: 520px){
      .grid{grid-template-columns: repeat(2, 1fr)}
      .boxStage{min-height: 720px}
    }

    /* ì´ˆì½œë¦¿ ì¹´ë“œ */
    .choco{
      position:relative;
      height: 120px;
      border-radius: 18px;
      cursor:pointer;
      user-select:none;
      transition: transform .22s ease, filter .22s ease;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 14px 35px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .choco:hover{ transform: translateY(-3px) scale(1.01); filter: brightness(1.03); }
    .choco:active{ transform: translateY(0) scale(.99); }

    .choco img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
      filter: saturate(1.03) contrast(1.02);
    }
    .choco .label{
      position:absolute;
      inset:auto 10px 10px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: rgba(255,255,255,.92);
      font-size: 12px;
      text-shadow: 0 10px 26px rgba(0,0,0,.55);
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(8px);
    }
    .openedTag{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(214,74,106,.28);
      border: 1px solid rgba(255,184,200,.42);
      display:none;
    }
    .choco[data-open="true"] .openedTag{display:inline-flex}

    /* í¸ì§€ íŒì—… */
    .letterWrap{
      position:absolute;
      left: 12px; right: 12px;
      top: 12px; bottom: 12px;
      pointer-events:none;
    }
    .letter{
      position:absolute;
      left:0; right:0;
      bottom: -110%;
      margin:auto;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,248,242,.92));
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: var(--softShadow);
      padding: 14px 14px 12px;
      transform: rotate(-1.2deg);
      opacity:0;
    }
    .letter:before{
      content:"";
      position:absolute; inset:0;
      border-radius: 16px;
      background:
        radial-gradient(320px 160px at 25% 20%, rgba(214,74,106,.12), transparent 60%),
        radial-gradient(320px 160px at 75% 75%, rgba(255,184,200,.12), transparent 60%);
      pointer-events:none;
      mix-blend-mode:multiply;
      opacity:.7;
    }
    .letter h3{
      position:relative;
      margin: 0 0 8px;
      font-size: 14px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .heartDot{
      width:10px; height:10px; border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff, #ffb8c8 50%, #d64a6a);
      box-shadow: 0 6px 14px rgba(214,74,106,.35);
    }
    .letter p{
      position:relative;
      margin: 0;
      font-size: 13px;
      line-height: 1.45;
      color: rgba(42,27,31,.92);
      white-space: pre-wrap;
    }
    .hint{
      position:relative;
      margin-top: 10px;
      font-size: 11px;
      color: rgba(42,27,31,.62);
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.7);
    }

    @keyframes popOut{
      0%{ bottom:-120%; opacity:0; transform: translateY(0) rotate(-1.2deg) scale(.98); }
      60%{ bottom: 10%; opacity:1; transform: translateY(-6px) rotate(.6deg) scale(1.02); }
      100%{ bottom: 6%; opacity:1; transform: translateY(0) rotate(.2deg) scale(1); }
    }

    .choco[data-open="true"]{ filter: grayscale(.12) brightness(.95); }
    .choco[data-open="true"] .letter{ animation: popOut .62s cubic-bezier(.2,.85,.25,1) forwards; }
    .choco[data-open="true"].settled .letter{
      bottom: 6%;
      opacity:1;
      transform: rotate(.2deg);
    }

    .shine{
      position:absolute; inset:-40% -40% auto auto;
      width: 120px; height: 120px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), transparent 60%);
      transform: rotate(25deg);
      opacity:.35;
      pointer-events:none;
    }

    /* ë¦¬ë·° ì„¹ì…˜ */
    .reviewArea{
      margin-top: 18px;
      border-radius: calc(var(--radius) + 6px);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadow);
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      display:none;
    }
    .reviewHead{
      padding: 16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.20));
      color: rgba(255,255,255,.92);
    }
    .reviewHead strong{font-size: 14px}
    .reviewBody{
      padding: 16px 18px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      color: rgba(255,255,255,.88);
    }

    .stars{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 12px;}
    .starRow{display:flex; gap:6px; align-items:center;}
    .starBtn{
      width: 34px; height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.9);
      cursor:pointer;
      display:grid; place-items:center;
      transition: transform .12s ease, background .12s ease;
    }
    .starBtn:hover{ transform: translateY(-1px); background: rgba(214,74,106,.22); }
    .starBtn.active{ background: rgba(214,74,106,.30); border-color: rgba(255,184,200,.45); }

    textarea{
      width:100%;
      min-height: 110px;
      resize: vertical;
      border-radius: 16px;
      padding: 12px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      outline:none;
    }
    textarea::placeholder{ color: rgba(255,255,255,.55); }
    .actions{
      margin-top: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.22);
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(214,74,106,.22); }
    .muted{ font-size: 12px; color: rgba(255,255,255,.70); }

    /* í•˜ë‹¨ ë„í¬ */
    .dock{
      position:fixed;
      left: 0; right:0; bottom: 14px;
      display:flex;
      justify-content:center;
      padding: 0 16px;
      z-index: 50;
    }
    .dockInner{
      width:min(720px, 100%);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 12px;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      color: rgba(255,255,255,.88);
    }
    .dockLeft{display:flex; gap:10px; align-items:center}
    .dockRight{display:flex; gap:10px; align-items:center}
    .iconBtn{
      width: 42px; height: 42px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      transition: transform .12s ease, background .12s ease;
      user-select:none;
    }
    .iconBtn:hover{ transform: translateY(-1px); background: rgba(214,74,106,.22); }
    .count{ font-size: 12px; opacity:.9; }

    /* ì €ì¥ ë¦¬ë·° ì„œë */
    .drawer{
      position:fixed;
      left:0; right:0;
      bottom: 74px;
      display:flex;
      justify-content:center;
      padding: 0 16px;
      z-index: 60;
      pointer-events:none;
    }
    .drawerPanel{
      width:min(720px, 100%);
      max-height: 52vh;
      overflow:auto;
      border-radius: 22px;
      background: rgba(15,5,9,.62);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      transform: translateY(12px);
      opacity:0;
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:auto;
      display:none;
    }
    .drawerPanel.open{ display:block; opacity:1; transform: translateY(0); }
    .drawerHead{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(255,255,255,.92);
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .drawerHead strong{font-size: 14px}
    .drawerList{ padding: 12px 14px 16px; }
    .reviewCard{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      padding: 12px;
      margin-bottom: 10px;
      color: rgba(255,255,255,.92);
    }
    .reviewCard .meta{
      display:flex; justify-content:space-between; gap:10px;
      font-size: 12px;
      color: rgba(255,255,255,.72);
      margin-bottom: 6px;
    }
    .reviewCard .text{ font-size: 13px; line-height: 1.45; white-space: pre-wrap; }

    /* í† ìŠ¤íŠ¸ */
    .toast{
      position:fixed;
      top: 16px;
      left:50%;
      transform: translateX(-50%);
      z-index: 80;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true"></div>
  <div class="grain" aria-hidden="true"></div>

  <div class="toast" id="toast"></div>

  <main class="wrap">
    <header>
      <div class="title">
        <h1>Open the Chocolates</h1>
        <p class="sub">ì´ˆì½œë¦¿ì„ ëˆŒëŸ¬ í¸ì§€ë¥¼ í•˜ë‚˜ì”© êº¼ë‚´ë´. ë‹¤ ì—´ë©´ ì‹œì‹í‰ì„ ì €ì¥í•  ìˆ˜ ìˆì–´ ğŸ«ğŸ’Œ</p>
      </div>
      <div class="progress">
        <div class="pill" id="openedCount">0 / 12 opened</div>
        <div class="pill" id="statusPill">tap a chocolate</div>
      </div>
    </header>

    <section class="boxStage" aria-label="ì´ˆì½œë¦¿ ìƒì">
      <div class="boxOverlay" aria-hidden="true"></div>
      <div class="grid" id="grid"></div>
    </section>

    <section class="reviewArea" id="reviewArea" aria-label="ì‹œì‹í‰ ì‘ì„±">
      <div class="reviewHead">
        <strong>ëª¨ë“  ì´ˆì½œë¦¿ì„ ì—´ì—ˆì–´! â­ ì‹œì‹í‰ì„ ë‚¨ê²¨ì¤˜</strong>
        <span class="muted">ì €ì¥í•˜ë©´ ì•„ë˜ ğŸ’¬ ì—ì„œ ë‹¤ì‹œ í™•ì¸ ê°€ëŠ¥</span>
      </div>
      <div class="reviewBody">
        <div class="stars">
          <div class="starRow" id="starRow" aria-label="ë³„ì  ì„ íƒ"></div>
          <div class="muted" id="starHint">ë³„ì ì„ ì„ íƒí•´ì¤˜ (1~5)</div>
        </div>

        <textarea id="reviewText" placeholder="ì˜ˆ) ê²‰ì€ ë°”ì‚­í•˜ê³  ì•ˆì€ ë¶€ë“œëŸ¬ì›Œì„œâ€¦ íŒ¨í‚¤ì§€ê°€ ë„ˆë¬´ ê·€ì—¬ì› ë‹¤â€¦"></textarea>

        <div class="actions">
          <button class="btn" id="saveReview">ì €ì¥í•˜ê¸°</button>
          <div class="muted" id="saveHint">localStorageì— ì €ì¥ë¼ì„œ ìƒˆë¡œê³ ì¹¨í•´ë„ ë‚¨ì•„ìˆì–´.</div>
        </div>
      </div>
    </section>
  </main>

  <div class="dock" aria-label="í•˜ë‹¨ ë©”ë‰´">
    <div class="dockInner">
      <div class="dockLeft">
        <div class="iconBtn" id="resetBtn" title="ë‹¤ì‹œ ì‹œì‘">â†»</div>
        <div class="count" id="dockCount">0 / 12</div>
      </div>
      <div class="dockRight">
        <div class="iconBtn" id="commentsBtn" title="ì €ì¥ëœ ì‹œì‹í‰ ë³´ê¸°">ğŸ’¬</div>
      </div>
    </div>
  </div>

  <div class="drawer" aria-hidden="false">
    <div class="drawerPanel" id="drawerPanel" role="dialog" aria-label="ì €ì¥ëœ ì‹œì‹í‰">
      <div class="drawerHead">
        <strong>ì €ì¥ëœ ì‹œì‹í‰</strong>
        <button class="btn" id="closeDrawer" style="padding:8px 10px;border-radius:999px;">ë‹«ê¸°</button>
      </div>
      <div class="drawerList" id="drawerList"></div>
    </div>
  </div>

  <script>
    // ====== ì´ë¯¸ì§€/í¸ì§€ ë°ì´í„° ======
    // ì´ë¯¸ì§€ íŒŒì¼ì€ assets í´ë”ì—: bg.jpg, box.jpg, heart.jpg, sweet.jpg, cake.jpg
    const chocolates = [
      { img: "assets/heart.jpg", title: "Felt Heart", note: "ì˜¤ëŠ˜ì˜ ë„ˆëŠ”â€¦ ìƒê°ë³´ë‹¤ ë” ë”°ëœ»í–ˆì–´.\nê·¸ê²Œ ì°¸ ê³ ë§ˆì›Œ." },
      { img: "assets/sweet.jpg", title: "Sweet Tray", note: "ë‹¬ì½¤í•¨ì€ ì‘ê²Œ, ì§„ì‹¬ì€ í¬ê²Œ.\në„ˆì—ê²ŒëŠ” ëŠ˜ ê·¸ë¬ì–´." },
      { img: "assets/box.jpg", title: "Heart Box", note: "ì„ ë¬¼ì€ ëª¨ì–‘ë³´ë‹¤ â€˜êº¼ë‚´ë³´ëŠ” ìˆœê°„â€™ì´ ë” ê¸°ì–µì— ë‚¨ë”ë¼." },
      { img: "assets/cake.jpg", title: "Heart Cake", note: "í•œ ì…ì´ë©´ ì¶©ë¶„í•´.\nâ€˜ê´œì°®ì•„â€™ë¼ëŠ” ë§ ëŒ€ì‹  ì´ê±¸ ì¤„ê²Œ." },

      { img: "assets/heart.jpg", title: "Little Heart", note: "ë„¤ê°€ ì¢‹ì•„í•˜ë˜ ê²ƒë“¤,\nì•„ì§ë„ ë‚˜ëŠ” ë‹¤ ê¸°ì–µí•´." },
      { img: "assets/sweet.jpg", title: "Pink Sweet", note: "ë‹¬ì½¤í•œ ê±´ ê¸ˆë°© ì‚¬ë¼ì ¸ë„,\nì—¬ìš´ì€ ì˜¤ë˜ ë‚¨ì•„." },
      { img: "assets/box.jpg", title: "Ribbon Bite", note: "ë¦¬ë³¸ì€ í’€ì–´ë„ ë¼.\nëŒ€ì‹  ë§ˆìŒì€ ì¡°ì‹¬íˆ êº¼ë‚´ì¤˜." },
      { img: "assets/cake.jpg", title: "Cherry Top", note: "ë§ˆì§€ë§‰ì€ ëŠ˜ ì²´ë¦¬ì²˜ëŸ¼.\në”± í•œ ë²ˆ ë” ì›ƒê²Œ í•´ì£¼ê³  ì‹¶ì–´." },

      { img: "assets/heart.jpg", title: "Stitched Love", note: "ì„œíˆ´ëŸ¬ë„ ì†ìœ¼ë¡œ ê¿°ë§¨ ë§ˆìŒì€\nì‰½ê²Œ í’€ë¦¬ì§€ ì•Šë”ë¼." },
      { img: "assets/sweet.jpg", title: "Soft Bite", note: "ë„ˆë¬´ ë‹¬ì§€ë§Œì€ ì•Šê²Œâ€”\nê·¸ë˜ë„ í–‰ë³µì€ ì¶©ë¶„íˆ." },
      { img: "assets/box.jpg", title: "Final Piece", note: "ì—¬ê¸°ê¹Œì§€ ì™€ì¤˜ì„œ ê³ ë§ˆì›Œ.\nì´ì œ ë„¤ ë§ë„ ë“¤ë ¤ì¤˜." },
      { img: "assets/cake.jpg", title: "Aftertaste", note: "ë‹¤ ì—´ì–´ë³¸ ë’¤ì˜ ì—¬ìš´ì€,\në„¤ê°€ ë‚¨ê¸°ëŠ” í•œ ì¤„ì— ë‹¬ë ¤ìˆì–´." },
    ];

    const OPEN_KEY = "vday_opened_v2";
    const REVIEWS_KEY = "vday_reviews_v2";

    const grid = document.getElementById("grid");
    const openedCount = document.getElementById("openedCount");
    const dockCount = document.getElementById("dockCount");
    const statusPill = document.getElementById("statusPill");

    const reviewArea = document.getElementById("reviewArea");
    const starRow = document.getElementById("starRow");
    const starHint = document.getElementById("starHint");
    const reviewText = document.getElementById("reviewText");
    const saveReviewBtn = document.getElementById("saveReview");

    const commentsBtn = document.getElementById("commentsBtn");
    const drawerPanel = document.getElementById("drawerPanel");
    const drawerList = document.getElementById("drawerList");
    const closeDrawer = document.getElementById("closeDrawer");
    const resetBtn = document.getElementById("resetBtn");
    const toast = document.getElementById("toast");

    let opened = new Set(loadOpened());
    let currentStars = 0;

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove("show"), 1500);
    }

    function loadOpened(){
      try{
        const raw = localStorage.getItem(OPEN_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch{ return []; }
    }
    function saveOpened(){
      localStorage.setItem(OPEN_KEY, JSON.stringify([...opened]));
    }
    function loadReviews(){
      try{
        const raw = localStorage.getItem(REVIEWS_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch{ return []; }
    }
    function saveReviews(list){
      localStorage.setItem(REVIEWS_KEY, JSON.stringify(list));
    }

    function updateCounts(){
      const total = chocolates.length;
      const n = opened.size;
      openedCount.textContent = `${n} / ${total} opened`;
      dockCount.textContent = `${n} / ${total}`;
      statusPill.textContent = (n === total) ? "all opened âœ“" : "tap a chocolate";
      if(n === total) reviewArea.style.display = "block";
    }

    function renderGrid(){
      grid.innerHTML = "";
      chocolates.forEach((c, idx) => {
        const el = document.createElement("button");
        el.type = "button";
        el.className = "choco";
        el.setAttribute("aria-label", `${c.title} ì´ˆì½œë¦¿ ì—´ê¸°`);
        el.dataset.index = String(idx);
        el.dataset.open = opened.has(idx) ? "true" : "false";

        el.innerHTML = `
          <span class="shine" aria-hidden="true"></span>
          <img alt="${escapeHtml(c.title)}" src="${escapeHtml(c.img)}" />
          <div class="label">
            <span class="badge">${escapeHtml(c.title)}</span>
            <span class="openedTag">opened</span>
          </div>
          <div class="letterWrap" aria-hidden="true">
            <div class="letter">
              <h3><span class="heartDot"></span> ${escapeHtml(c.title)}</h3>
              <p>${escapeHtml(c.note)}</p>
              <div class="hint">
                <span>í¸ì§€ í•œ ì¥ êº¼ëƒ„</span>
                <span><span class="kbd">click</span>ë¡œ ë‹¤ìŒ</span>
              </div>
            </div>
          </div>
        `;

        el.addEventListener("click", () => openChocolate(idx, el));
        grid.appendChild(el);

        if(opened.has(idx)){
          requestAnimationFrame(() => el.classList.add("settled"));
        }
      });
    }

    function openChocolate(idx, el){
      if(opened.has(idx)){
        showToast("ì´ë¯¸ ì—´ì–´ë³¸ ì´ˆì½œë¦¿ì´ì•¼ ğŸ’Œ");
        return;
      }
      opened.add(idx);
      saveOpened();
      el.dataset.open = "true";
      setTimeout(()=> el.classList.add("settled"), 680);

      updateCounts();

      if(opened.size === chocolates.length){
        showToast("ì „ë¶€ ì—´ì—ˆì–´! ì´ì œ ì‹œì‹í‰ì„ ë‚¨ê²¨ì¤˜ â­");
        setTimeout(()=> reviewArea.scrollIntoView({behavior:"smooth", block:"start"}), 350);
      }else{
        showToast("í¸ì§€ë¥¼ êº¼ëƒˆì–´ ğŸ«");
      }
    }

    function renderStars(){
      starRow.innerHTML = "";
      for(let i=1;i<=5;i++){
        const b = document.createElement("button");
        b.type="button";
        b.className="starBtn";
        b.textContent="â˜…";
        b.setAttribute("aria-label", `${i}ì `);
        b.addEventListener("click", ()=> setStars(i));
        starRow.appendChild(b);
      }
      syncStars();
    }
    function setStars(n){
      currentStars = n;
      syncStars();
      starHint.textContent = `${n} / 5`;
    }
    function syncStars(){
      [...starRow.children].forEach((btn, i)=>{
        btn.classList.toggle("active", i < currentStars);
      });
    }

    function renderDrawer(){
      const list = loadReviews();
      drawerList.innerHTML = "";
      if(list.length === 0){
        drawerList.innerHTML = `
          <div class="reviewCard">
            <div class="meta"><span>ì•„ì§ ì €ì¥ëœ ì‹œì‹í‰ì´ ì—†ì–´</span><span>ğŸ’¬</span></div>
            <div class="text">ëª¨ë“  ì´ˆì½œë¦¿ì„ ì—´ê³  ë³„ì +í›„ê¸°ë¥¼ ì €ì¥í•´ë´.</div>
          </div>
        `;
        return;
      }
      list.slice().reverse().forEach(item=>{
        const card = document.createElement("div");
        card.className = "reviewCard";
        card.innerHTML = `
          <div class="meta">
            <span>${"â˜…".repeat(item.stars)}${"â˜†".repeat(5-item.stars)}</span>
            <span>${new Date(item.createdAt).toLocaleString()}</span>
          </div>
          <div class="text">${escapeHtml(item.text)}</div>
        `;
        drawerList.appendChild(card);
      });
    }

    function saveReview(){
      if(opened.size !== chocolates.length){
        showToast("ì•„ì§ ëª¨ë“  ì´ˆì½œë¦¿ì„ ì—´ì§€ ì•Šì•˜ì–´!");
        return;
      }
      if(currentStars === 0){
        showToast("ë³„ì ì„ ë¨¼ì € ì„ íƒí•´ì¤˜ â­");
        return;
      }
      const text = reviewText.value.trim();
      if(!text){
        showToast("ì‹œì‹í‰ì„ í•œ ì¤„ì´ë¼ë„ ì ì–´ì¤˜!");
        return;
      }

      const list = loadReviews();
      list.push({ stars: currentStars, text, createdAt: Date.now() });
      saveReviews(list);

      reviewText.value = "";
      currentStars = 0;
      syncStars();
      starHint.textContent = "ì €ì¥ë¨ âœ“";

      showToast("ì‹œì‹í‰ì„ ì €ì¥í–ˆì–´ ğŸ’¬");
      renderDrawer();
    }

    function toggleDrawer(force){
      const wantOpen = (typeof force === "boolean") ? force : !drawerPanel.classList.contains("open");
      if(wantOpen){
        renderDrawer();
        drawerPanel.classList.add("open");
      }else{
        drawerPanel.classList.remove("open");
      }
    }

    function resetAll(){
      opened = new Set();
      localStorage.removeItem(OPEN_KEY);
      renderGrid();
      updateCounts();
      showToast("ì²˜ìŒë¶€í„° ë‹¤ì‹œ ğŸ«");
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    renderGrid();
    renderStars();
    updateCounts();
    renderDrawer();

    saveReviewBtn.addEventListener("click", saveReview);
    commentsBtn.addEventListener("click", ()=> toggleDrawer());
    closeDrawer.addEventListener("click", ()=> toggleDrawer(false));
    resetBtn.addEventListener("click", resetAll);

    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") toggleDrawer(false);
    });
  </script>
</body>
</html>
